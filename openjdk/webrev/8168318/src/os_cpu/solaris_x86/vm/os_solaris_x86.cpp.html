<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/os_cpu/solaris_x86/vm/os_solaris_x86.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1999, 2016, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include "asm/macroAssembler.hpp"
  27 #include "classfile/classLoader.hpp"
  28 #include "classfile/systemDictionary.hpp"
  29 #include "classfile/vmSymbols.hpp"
  30 #include "code/codeCache.hpp"
  31 #include "code/icBuffer.hpp"
  32 #include "code/vtableStubs.hpp"
  33 #include "interpreter/interpreter.hpp"
  34 #include "jvm_solaris.h"
  35 #include "memory/allocation.inline.hpp"
  36 #include "os_share_solaris.hpp"
  37 #include "prims/jniFastGetField.hpp"
  38 #include "prims/jvm.h"
  39 #include "prims/jvm_misc.hpp"
  40 #include "runtime/arguments.hpp"
  41 #include "runtime/atomic.hpp"
  42 #include "runtime/extendedPC.hpp"
  43 #include "runtime/frame.inline.hpp"
  44 #include "runtime/interfaceSupport.hpp"
  45 #include "runtime/java.hpp"
  46 #include "runtime/javaCalls.hpp"
  47 #include "runtime/mutexLocker.hpp"
  48 #include "runtime/osThread.hpp"
  49 #include "runtime/sharedRuntime.hpp"
  50 #include "runtime/stubRoutines.hpp"
  51 #include "runtime/thread.inline.hpp"
  52 #include "runtime/timer.hpp"
  53 #include "utilities/events.hpp"
  54 #include "utilities/vmError.hpp"
  55 
  56 // put OS-includes here
  57 # include &lt;sys/types.h&gt;
  58 # include &lt;sys/mman.h&gt;
  59 # include &lt;pthread.h&gt;
  60 # include &lt;signal.h&gt;
  61 # include &lt;setjmp.h&gt;
  62 # include &lt;errno.h&gt;
  63 # include &lt;dlfcn.h&gt;
  64 # include &lt;stdio.h&gt;
  65 # include &lt;unistd.h&gt;
  66 # include &lt;sys/resource.h&gt;
  67 # include &lt;thread.h&gt;
  68 # include &lt;sys/stat.h&gt;
  69 # include &lt;sys/time.h&gt;
  70 # include &lt;sys/filio.h&gt;
  71 # include &lt;sys/utsname.h&gt;
  72 # include &lt;sys/systeminfo.h&gt;
  73 # include &lt;sys/socket.h&gt;
  74 # include &lt;sys/trap.h&gt;
  75 # include &lt;sys/lwp.h&gt;
  76 # include &lt;poll.h&gt;
  77 # include &lt;sys/lwp.h&gt;
  78 # include &lt;procfs.h&gt;     //  see comment in &lt;sys/procfs.h&gt;
  79 
  80 #ifndef AMD64
  81 // QQQ seems useless at this point
  82 # define _STRUCTURED_PROC 1  //  this gets us the new structured proc interfaces of 5.6 &amp; later
  83 #endif // AMD64
  84 # include &lt;sys/procfs.h&gt;     //  see comment in &lt;sys/procfs.h&gt;
  85 
  86 
  87 #define MAX_PATH (2 * K)
  88 
  89 // Minimum stack sizes for the VM.  It's easier to document a constant value
  90 // but it's different for x86 and sparc because the page sizes are different.
  91 #ifdef AMD64
  92 size_t os::Posix::_compiler_thread_min_stack_allowed = 394 * K;
  93 size_t os::Posix::_java_thread_min_stack_allowed = 224 * K;
  94 size_t os::Posix::_vm_internal_thread_min_stack_allowed = 224 * K;
  95 #define REG_SP REG_RSP
  96 #define REG_PC REG_RIP
  97 #define REG_FP REG_RBP
  98 #else
  99 size_t os::Posix::_compiler_thread_min_stack_allowed = 64 * K;
 100 size_t os::Posix::_java_thread_min_stack_allowed = 64 * K;
 101 size_t os::Posix::_vm_internal_thread_min_stack_allowed = 64 * K;
 102 #define REG_SP UESP
 103 #define REG_PC EIP
 104 #define REG_FP EBP
 105 // 4900493 counter to prevent runaway LDTR refresh attempt
 106 
 107 static volatile int ldtr_refresh = 0;
 108 // the libthread instruction that faults because of the stale LDTR
 109 
 110 static const unsigned char movlfs[] = { 0x8e, 0xe0    // movl %eax,%fs
 111                        };
 112 #endif // AMD64
 113 
 114 char* os::non_memory_address_word() {
 115   // Must never look like an address returned by reserve_memory,
 116   // even in its subfields (as defined by the CPU immediate fields,
 117   // if the CPU splits constants across multiple instructions).
 118   return (char*) -1;
 119 }
 120 
 121 //
 122 // Validate a ucontext retrieved from walking a uc_link of a ucontext.
 123 // There are issues with libthread giving out uc_links for different threads
 124 // on the same uc_link chain and bad or circular links.
 125 //
 126 bool os::Solaris::valid_ucontext(Thread* thread, const ucontext_t* valid, const ucontext_t* suspect) {
 127   if (valid &gt;= suspect ||
 128       valid-&gt;uc_stack.ss_flags != suspect-&gt;uc_stack.ss_flags ||
 129       valid-&gt;uc_stack.ss_sp    != suspect-&gt;uc_stack.ss_sp    ||
 130       valid-&gt;uc_stack.ss_size  != suspect-&gt;uc_stack.ss_size) {
 131     DEBUG_ONLY(tty-&gt;print_cr("valid_ucontext: failed test 1");)
 132     return false;
 133   }
 134 
 135   if (thread-&gt;is_Java_thread()) {
 136     if (!valid_stack_address(thread, (address)suspect)) {
 137       DEBUG_ONLY(tty-&gt;print_cr("valid_ucontext: uc_link not in thread stack");)
 138       return false;
 139     }
 140     if (!valid_stack_address(thread,  (address) suspect-&gt;uc_mcontext.gregs[REG_SP])) {
 141       DEBUG_ONLY(tty-&gt;print_cr("valid_ucontext: stackpointer not in thread stack");)
 142       return false;
 143     }
 144   }
 145   return true;
 146 }
 147 
 148 // We will only follow one level of uc_link since there are libthread
 149 // issues with ucontext linking and it is better to be safe and just
 150 // let caller retry later.
 151 const ucontext_t* os::Solaris::get_valid_uc_in_signal_handler(Thread *thread,
 152   const ucontext_t *uc) {
 153 
 154   const ucontext_t *retuc = NULL;
 155 
 156   if (uc != NULL) {
 157     if (uc-&gt;uc_link == NULL) {
 158       // cannot validate without uc_link so accept current ucontext
 159       retuc = uc;
 160     } else if (os::Solaris::valid_ucontext(thread, uc, uc-&gt;uc_link)) {
 161       // first ucontext is valid so try the next one
 162       uc = uc-&gt;uc_link;
 163       if (uc-&gt;uc_link == NULL) {
 164         // cannot validate without uc_link so accept current ucontext
 165         retuc = uc;
 166       } else if (os::Solaris::valid_ucontext(thread, uc, uc-&gt;uc_link)) {
 167         // the ucontext one level down is also valid so return it
 168         retuc = uc;
 169       }
 170     }
 171   }
 172   return retuc;
 173 }
 174 
 175 // Assumes ucontext is valid
 176 ExtendedPC os::Solaris::ucontext_get_ExtendedPC(const ucontext_t *uc) {
 177   return ExtendedPC((address)uc-&gt;uc_mcontext.gregs[REG_PC]);
 178 }
 179 
 180 void os::Solaris::ucontext_set_pc(ucontext_t* uc, address pc) {
 181   uc-&gt;uc_mcontext.gregs [REG_PC]  = (greg_t) pc;
 182 }
 183 
 184 // Assumes ucontext is valid
 185 intptr_t* os::Solaris::ucontext_get_sp(const ucontext_t *uc) {
 186   return (intptr_t*)uc-&gt;uc_mcontext.gregs[REG_SP];
 187 }
 188 
 189 // Assumes ucontext is valid
 190 intptr_t* os::Solaris::ucontext_get_fp(const ucontext_t *uc) {
 191   return (intptr_t*)uc-&gt;uc_mcontext.gregs[REG_FP];
 192 }
 193 
 194 address os::Solaris::ucontext_get_pc(const ucontext_t *uc) {
 195   return (address) uc-&gt;uc_mcontext.gregs[REG_PC];
 196 }
 197 
 198 // For Forte Analyzer AsyncGetCallTrace profiling support - thread
 199 // is currently interrupted by SIGPROF.
 200 //
 201 // The difference between this and os::fetch_frame_from_context() is that
 202 // here we try to skip nested signal frames.
 203 // This method is also used for stack overflow signal handling.
 204 ExtendedPC os::Solaris::fetch_frame_from_ucontext(Thread* thread,
 205   const ucontext_t* uc, intptr_t** ret_sp, intptr_t** ret_fp) {
 206 
 207   assert(thread != NULL, "just checking");
 208   assert(ret_sp != NULL, "just checking");
 209   assert(ret_fp != NULL, "just checking");
 210 
 211   const ucontext_t *luc = os::Solaris::get_valid_uc_in_signal_handler(thread, uc);
 212   return os::fetch_frame_from_context(luc, ret_sp, ret_fp);
 213 }
 214 
 215 ExtendedPC os::fetch_frame_from_context(const void* ucVoid,
 216                     intptr_t** ret_sp, intptr_t** ret_fp) {
 217 
 218   ExtendedPC  epc;
 219   const ucontext_t *uc = (const ucontext_t*)ucVoid;
 220 
 221   if (uc != NULL) {
 222     epc = os::Solaris::ucontext_get_ExtendedPC(uc);
 223     if (ret_sp) *ret_sp = os::Solaris::ucontext_get_sp(uc);
 224     if (ret_fp) *ret_fp = os::Solaris::ucontext_get_fp(uc);
 225   } else {
 226     // construct empty ExtendedPC for return value checking
 227     epc = ExtendedPC(NULL);
 228     if (ret_sp) *ret_sp = (intptr_t *)NULL;
 229     if (ret_fp) *ret_fp = (intptr_t *)NULL;
 230   }
 231 
 232   return epc;
 233 }
 234 
 235 frame os::fetch_frame_from_context(const void* ucVoid) {
 236   intptr_t* sp;
 237   intptr_t* fp;
 238   ExtendedPC epc = fetch_frame_from_context(ucVoid, &amp;sp, &amp;fp);
 239   return frame(sp, fp, epc.pc());
 240 }
 241 
 242 frame os::fetch_frame_from_ucontext(Thread* thread, void* ucVoid) {
 243   intptr_t* sp;
 244   intptr_t* fp;
 245   ExtendedPC epc = os::Solaris::fetch_frame_from_ucontext(thread, (ucontext_t*)ucVoid, &amp;sp, &amp;fp);
 246   return frame(sp, fp, epc.pc());
 247 }
 248 
 249 bool os::Solaris::get_frame_at_stack_banging_point(JavaThread* thread, ucontext_t* uc, frame* fr) {
 250  address pc = (address) os::Solaris::ucontext_get_pc(uc);
 251   if (Interpreter::contains(pc)) {
 252     // interpreter performs stack banging after the fixed frame header has
 253     // been generated while the compilers perform it before. To maintain
 254     // semantic consistency between interpreted and compiled frames, the
 255     // method returns the Java sender of the current frame.
 256     *fr = os::fetch_frame_from_ucontext(thread, uc);
 257     if (!fr-&gt;is_first_java_frame()) {
 258       // get_frame_at_stack_banging_point() is only called when we
 259       // have well defined stacks so java_sender() calls do not need
 260       // to assert safe_for_sender() first.
 261       *fr = fr-&gt;java_sender();
 262     }
 263   } else {
 264     // more complex code with compiled code
 265     assert(!Interpreter::contains(pc), "Interpreted methods should have been handled above");
 266     CodeBlob* cb = CodeCache::find_blob(pc);
 267     if (cb == NULL || !cb-&gt;is_nmethod() || cb-&gt;is_frame_complete_at(pc)) {
 268       // Not sure where the pc points to, fallback to default
 269       // stack overflow handling
 270       return false;
 271     } else {
 272       // in compiled code, the stack banging is performed just after the return pc
 273       // has been pushed on the stack
 274       intptr_t* fp = os::Solaris::ucontext_get_fp(uc);
 275       intptr_t* sp = os::Solaris::ucontext_get_sp(uc);
 276       *fr = frame(sp + 1, fp, (address)*sp);
 277       if (!fr-&gt;is_java_frame()) {
 278         // See java_sender() comment above.
 279         *fr = fr-&gt;java_sender();
 280       }
 281     }
 282   }
 283   assert(fr-&gt;is_java_frame(), "Safety check");
 284   return true;
 285 }
 286 
 287 frame os::get_sender_for_C_frame(frame* fr) {
 288   return frame(fr-&gt;sender_sp(), fr-&gt;link(), fr-&gt;sender_pc());
 289 }
 290 
 291 extern "C" intptr_t *_get_current_sp();  // in .il file
 292 
 293 address os::current_stack_pointer() {
 294   return (address)_get_current_sp();
 295 }
 296 
 297 extern "C" intptr_t *_get_current_fp();  // in .il file
 298 
 299 frame os::current_frame() {
 300   intptr_t* fp = _get_current_fp();  // it's inlined so want current fp
 301   // fp is for os::current_frame. We want the fp for our caller.
 302   frame myframe((intptr_t*)os::current_stack_pointer(),
 303                 (intptr_t*)fp,
 304                 CAST_FROM_FN_PTR(address, os::current_frame));
 305   frame caller_frame = os::get_sender_for_C_frame(&amp;myframe);
 306 
 307   if (os::is_first_C_frame(&amp;caller_frame)) {
 308     // stack is not walkable
 309     frame ret; // This will be a null useless frame
 310     return ret;
 311   } else {
 312     // return frame for our caller's caller
 313     return os::get_sender_for_C_frame(&amp;caller_frame);
 314   }
 315 }
 316 
 317 #ifndef AMD64
 318 
 319 // Detecting SSE support by OS
 320 // From solaris_i486.s
 321 extern "C" bool sse_check();
 322 extern "C" bool sse_unavailable();
 323 
 324 enum { SSE_UNKNOWN, SSE_NOT_SUPPORTED, SSE_SUPPORTED};
 325 static int sse_status = SSE_UNKNOWN;
 326 
 327 
 328 static void  check_for_sse_support() {
 329   if (!VM_Version::supports_sse()) {
 330     sse_status = SSE_NOT_SUPPORTED;
 331     return;
 332   }
 333   // looking for _sse_hw in libc.so, if it does not exist or
 334   // the value (int) is 0, OS has no support for SSE
 335   int *sse_hwp;
 336   void *h;
 337 
 338   if ((h=dlopen("/usr/lib/libc.so", RTLD_LAZY)) == NULL) {
 339     //open failed, presume no support for SSE
 340     sse_status = SSE_NOT_SUPPORTED;
 341     return;
 342   }
 343   if ((sse_hwp = (int *)dlsym(h, "_sse_hw")) == NULL) {
 344     sse_status = SSE_NOT_SUPPORTED;
 345   } else if (*sse_hwp == 0) {
 346     sse_status = SSE_NOT_SUPPORTED;
 347   }
 348   dlclose(h);
 349 
 350   if (sse_status == SSE_UNKNOWN) {
 351     bool (*try_sse)() = (bool (*)())sse_check;
 352     sse_status = (*try_sse)() ? SSE_SUPPORTED : SSE_NOT_SUPPORTED;
 353   }
 354 
 355 }
 356 
 357 #endif // AMD64
 358 
 359 bool os::supports_sse() {
 360 #ifdef AMD64
 361   return true;
 362 #else
 363   if (sse_status == SSE_UNKNOWN)
 364     check_for_sse_support();
 365   return sse_status == SSE_SUPPORTED;
 366 #endif // AMD64
 367 }
 368 
 369 bool os::is_allocatable(size_t bytes) {
 370 #ifdef AMD64
 371   return true;
 372 #else
 373 
 374   if (bytes &lt; 2 * G) {
 375     return true;
 376   }
 377 
 378   char* addr = reserve_memory(bytes, NULL);
 379 
 380   if (addr != NULL) {
 381     release_memory(addr, bytes);
 382   }
 383 
 384   return addr != NULL;
 385 #endif // AMD64
 386 
 387 }
 388 
 389 extern "C" JNIEXPORT int
 390 JVM_handle_solaris_signal(int sig, siginfo_t* info, void* ucVoid,
 391                           int abort_if_unrecognized) {
 392   ucontext_t* uc = (ucontext_t*) ucVoid;
 393 
 394 #ifndef AMD64
 395   if (sig == SIGILL &amp;&amp; info-&gt;si_addr == (caddr_t)sse_check) {
 396     // the SSE instruction faulted. supports_sse() need return false.
 397     uc-&gt;uc_mcontext.gregs[EIP] = (greg_t)sse_unavailable;
 398     return true;
 399   }
 400 #endif // !AMD64
 401 
 402   Thread* t = Thread::current_or_null_safe();
 403 
 404   // Must do this before SignalHandlerMark, if crash protection installed we will longjmp away
 405   // (no destructors can be run)
 406   os::WatcherThreadCrashProtection::check_crash_protection(sig, t);
 407 
 408   SignalHandlerMark shm(t);
 409 
 410   if(sig == SIGPIPE || sig == SIGXFSZ) {
 411     if (os::Solaris::chained_handler(sig, info, ucVoid)) {
 412       return true;
 413     } else {
 414       // Ignoring SIGPIPE/SIGXFSZ - see bugs 4229104 or 6499219
 415       return true;
 416     }
 417   }
 418 
 419   JavaThread* thread = NULL;
 420   VMThread* vmthread = NULL;
 421 
 422   if (os::Solaris::signal_handlers_are_installed) {
 423     if (t != NULL ){
 424       if(t-&gt;is_Java_thread()) {
 425         thread = (JavaThread*)t;
 426       }
 427       else if(t-&gt;is_VM_thread()){
 428         vmthread = (VMThread *)t;
 429       }
 430     }
 431   }
 432 
 433   if (sig == os::Solaris::SIGasync()) {
 434     if(thread || vmthread){
 435       OSThread::SR_handler(t, uc);
 436       return true;
 437     } else if (os::Solaris::chained_handler(sig, info, ucVoid)) {
 438       return true;
 439     } else {
 440       // If os::Solaris::SIGasync not chained, and this is a non-vm and
 441       // non-java thread
 442       return true;
 443     }
 444   }
 445 
 446   if (info == NULL || info-&gt;si_code &lt;= 0 || info-&gt;si_code == SI_NOINFO) {
 447     // can't decode this kind of signal
 448     info = NULL;
 449   } else {
 450     assert(sig == info-&gt;si_signo, "bad siginfo");
 451   }
 452 
 453   // decide if this trap can be handled by a stub
 454   address stub = NULL;
 455 
 456   address pc          = NULL;
 457 
 458   //%note os_trap_1
 459   if (info != NULL &amp;&amp; uc != NULL &amp;&amp; thread != NULL) {
 460     // factor me: getPCfromContext
 461     pc = (address) uc-&gt;uc_mcontext.gregs[REG_PC];
 462 
 463     if (StubRoutines::is_safefetch_fault(pc)) {
 464       os::Solaris::ucontext_set_pc(uc, StubRoutines::continuation_for_safefetch_fault(pc));
 465       return true;
 466     }
 467 
 468     // Handle ALL stack overflow variations here
 469     if (sig == SIGSEGV &amp;&amp; info-&gt;si_code == SEGV_ACCERR) {
 470       address addr = (address) info-&gt;si_addr;
 471       if (thread-&gt;in_stack_yellow_reserved_zone(addr)) {
 472         if (thread-&gt;thread_state() == _thread_in_Java) {
 473           if (thread-&gt;in_stack_reserved_zone(addr)) {
 474             frame fr;
 475             if (os::Solaris::get_frame_at_stack_banging_point(thread, uc, &amp;fr)) {
 476               assert(fr.is_java_frame(), "Must be Java frame");
 477               frame activation = SharedRuntime::look_for_reserved_stack_annotated_method(thread, fr);
 478               if (activation.sp() != NULL) {
 479                 thread-&gt;disable_stack_reserved_zone();
 480                 if (activation.is_interpreted_frame()) {
 481                   thread-&gt;set_reserved_stack_activation((address)(
 482                     activation.fp() + frame::interpreter_frame_initial_sp_offset));
 483                 } else {
 484                   thread-&gt;set_reserved_stack_activation((address)activation.unextended_sp());
 485                 }
 486                 return true;
 487               }
 488             }
 489           }
 490           // Throw a stack overflow exception.  Guard pages will be reenabled
 491           // while unwinding the stack.
 492           thread-&gt;disable_stack_yellow_reserved_zone();
 493           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::STACK_OVERFLOW);
 494         } else {
 495           // Thread was in the vm or native code.  Return and try to finish.
 496           thread-&gt;disable_stack_yellow_reserved_zone();
 497           return true;
 498         }
 499       } else if (thread-&gt;in_stack_red_zone(addr)) {
 500         // Fatal red zone violation.  Disable the guard pages and fall through
 501         // to handle_unexpected_exception way down below.
 502         thread-&gt;disable_stack_red_zone();
 503         tty-&gt;print_raw_cr("An irrecoverable stack overflow has occurred.");
 504       }
 505     }
 506 
 507     if ((sig == SIGSEGV) &amp;&amp; VM_Version::is_cpuinfo_segv_addr(pc)) {
 508       // Verify that OS save/restore AVX registers.
 509       stub = VM_Version::cpuinfo_cont_addr();
 510     }
 511 
 512     if (thread-&gt;thread_state() == _thread_in_vm) {
 513       if (sig == SIGBUS &amp;&amp; info-&gt;si_code == BUS_OBJERR &amp;&amp; thread-&gt;doing_unsafe_access()) {
 514         address next_pc = Assembler::locate_next_instruction(pc);
 515         stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
 516       }
 517     }
 518 
 519     if (thread-&gt;thread_state() == _thread_in_Java) {
 520       // Support Safepoint Polling
 521       if ( sig == SIGSEGV &amp;&amp; os::is_poll_address((address)info-&gt;si_addr)) {
 522         stub = SharedRuntime::get_poll_stub(pc);
 523       }
 524       else if (sig == SIGBUS &amp;&amp; info-&gt;si_code == BUS_OBJERR) {
 525         // BugId 4454115: A read from a MappedByteBuffer can fault
 526         // here if the underlying file has been truncated.
 527         // Do not crash the VM in such a case.
 528         CodeBlob* cb = CodeCache::find_blob_unsafe(pc);
 529         if (cb != NULL) {
 530           CompiledMethod* nm = cb-&gt;as_compiled_method_or_null();
 531           if (nm != NULL &amp;&amp; nm-&gt;has_unsafe_access()) {
 532             address next_pc = Assembler::locate_next_instruction(pc);
 533             stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
 534           }
 535         }
 536       }
 537       else
 538       if (sig == SIGFPE &amp;&amp; info-&gt;si_code == FPE_INTDIV) {
 539         // integer divide by zero
 540         stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
 541       }
 542 #ifndef AMD64
 543       else if (sig == SIGFPE &amp;&amp; info-&gt;si_code == FPE_FLTDIV) {
 544         // floating-point divide by zero
 545         stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
 546       }
 547       else if (sig == SIGFPE &amp;&amp; info-&gt;si_code == FPE_FLTINV) {
 548         // The encoding of D2I in i486.ad can cause an exception prior
 549         // to the fist instruction if there was an invalid operation
 550         // pending. We want to dismiss that exception. From the win_32
 551         // side it also seems that if it really was the fist causing
 552         // the exception that we do the d2i by hand with different
 553         // rounding. Seems kind of weird. QQQ TODO
 554         // Note that we take the exception at the NEXT floating point instruction.
 555         if (pc[0] == 0xDB) {
 556             assert(pc[0] == 0xDB, "not a FIST opcode");
 557             assert(pc[1] == 0x14, "not a FIST opcode");
 558             assert(pc[2] == 0x24, "not a FIST opcode");
 559             return true;
 560         } else {
 561             assert(pc[-3] == 0xDB, "not an flt invalid opcode");
 562             assert(pc[-2] == 0x14, "not an flt invalid opcode");
 563             assert(pc[-1] == 0x24, "not an flt invalid opcode");
 564         }
 565       }
 566       else if (sig == SIGFPE ) {
 567         tty-&gt;print_cr("caught SIGFPE, info 0x%x.", info-&gt;si_code);
 568       }
 569 #endif // !AMD64
 570 
 571         // QQQ It doesn't seem that we need to do this on x86 because we should be able
 572         // to return properly from the handler without this extra stuff on the back side.
 573 
 574       else if (sig == SIGSEGV &amp;&amp; info-&gt;si_code &gt; 0 &amp;&amp; !MacroAssembler::needs_explicit_null_check((intptr_t)info-&gt;si_addr)) {
 575         // Determination of interpreter/vtable stub/compiled code null exception
 576         stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_NULL);
 577       }
 578     }
 579 
 580     // jni_fast_Get&lt;Primitive&gt;Field can trap at certain pc's if a GC kicks in
 581     // and the heap gets shrunk before the field access.
 582     if ((sig == SIGSEGV) || (sig == SIGBUS)) {
 583       address addr = JNI_FastGetField::find_slowcase_pc(pc);
 584       if (addr != (address)-1) {
 585         stub = addr;
 586       }
 587     }
 588 
 589     // Check to see if we caught the safepoint code in the
 590     // process of write protecting the memory serialization page.
 591     // It write enables the page immediately after protecting it
 592     // so we can just return to retry the write.
 593     if ((sig == SIGSEGV) &amp;&amp;
 594         os::is_memory_serialize_page(thread, (address)info-&gt;si_addr)) {
 595       // Block current thread until the memory serialize page permission restored.
 596       os::block_on_serialize_page_trap();
 597       return true;
 598     }
 599   }
 600 
 601   // Execution protection violation
 602   //
 603   // Preventative code for future versions of Solaris which may
 604   // enable execution protection when running the 32-bit VM on AMD64.
 605   //
 606   // This should be kept as the last step in the triage.  We don't
 607   // have a dedicated trap number for a no-execute fault, so be
 608   // conservative and allow other handlers the first shot.
 609   //
 610   // Note: We don't test that info-&gt;si_code == SEGV_ACCERR here.
 611   // this si_code is so generic that it is almost meaningless; and
 612   // the si_code for this condition may change in the future.
 613   // Furthermore, a false-positive should be harmless.
 614   if (UnguardOnExecutionViolation &gt; 0 &amp;&amp;
 615       (sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
 616       uc-&gt;uc_mcontext.gregs[TRAPNO] == T_PGFLT) {  // page fault
 617     int page_size = os::vm_page_size();
 618     address addr = (address) info-&gt;si_addr;
 619     address pc = (address) uc-&gt;uc_mcontext.gregs[REG_PC];
 620     // Make sure the pc and the faulting address are sane.
 621     //
 622     // If an instruction spans a page boundary, and the page containing
 623     // the beginning of the instruction is executable but the following
 624     // page is not, the pc and the faulting address might be slightly
 625     // different - we still want to unguard the 2nd page in this case.
 626     //
 627     // 15 bytes seems to be a (very) safe value for max instruction size.
 628     bool pc_is_near_addr =
 629       (pointer_delta((void*) addr, (void*) pc, sizeof(char)) &lt; 15);
 630     bool instr_spans_page_boundary =
 631       (align_size_down((intptr_t) pc ^ (intptr_t) addr,
 632                        (intptr_t) page_size) &gt; 0);
 633 
 634     if (pc == addr || (pc_is_near_addr &amp;&amp; instr_spans_page_boundary)) {
 635       static volatile address last_addr =
 636         (address) os::non_memory_address_word();
 637 
 638       // In conservative mode, don't unguard unless the address is in the VM
 639       if (addr != last_addr &amp;&amp;
 640           (UnguardOnExecutionViolation &gt; 1 || os::address_is_in_vm(addr))) {
 641 
 642         // Make memory rwx and retry
 643         address page_start =
 644           (address) align_size_down((intptr_t) addr, (intptr_t) page_size);
 645         bool res = os::protect_memory((char*) page_start, page_size,
 646                                       os::MEM_PROT_RWX);
 647 
 648         log_debug(os)("Execution protection violation "
 649                       "at " INTPTR_FORMAT
 650                       ", unguarding " INTPTR_FORMAT ": %s, errno=%d", p2i(addr),
 651                       p2i(page_start), (res ? "success" : "failed"), errno);
 652         stub = pc;
 653 
 654         // Set last_addr so if we fault again at the same address, we don't end
 655         // up in an endless loop.
 656         //
 657         // There are two potential complications here.  Two threads trapping at
 658         // the same address at the same time could cause one of the threads to
 659         // think it already unguarded, and abort the VM.  Likely very rare.
 660         //
 661         // The other race involves two threads alternately trapping at
 662         // different addresses and failing to unguard the page, resulting in
 663         // an endless loop.  This condition is probably even more unlikely than
 664         // the first.
 665         //
 666         // Although both cases could be avoided by using locks or thread local
 667         // last_addr, these solutions are unnecessary complication: this
 668         // handler is a best-effort safety net, not a complete solution.  It is
 669         // disabled by default and should only be used as a workaround in case
 670         // we missed any no-execute-unsafe VM code.
 671 
 672         last_addr = addr;
 673       }
 674     }
 675   }
 676 
 677   if (stub != NULL) {
 678     // save all thread context in case we need to restore it
 679 
 680     if (thread != NULL) thread-&gt;set_saved_exception_pc(pc);
 681     // 12/02/99: On Sparc it appears that the full context is also saved
 682     // but as yet, no one looks at or restores that saved context
 683     os::Solaris::ucontext_set_pc(uc, stub);
 684     return true;
 685   }
 686 
 687   // signal-chaining
 688   if (os::Solaris::chained_handler(sig, info, ucVoid)) {
 689     return true;
 690   }
 691 
 692 #ifndef AMD64
 693   // Workaround (bug 4900493) for Solaris kernel bug 4966651.
 694   // Handle an undefined selector caused by an attempt to assign
 695   // fs in libthread getipriptr(). With the current libthread design every 512
 696   // thread creations the LDT for a private thread data structure is extended
 697   // and thre is a hazard that and another thread attempting a thread creation
 698   // will use a stale LDTR that doesn't reflect the structure's growth,
 699   // causing a GP fault.
 700   // Enforce the probable limit of passes through here to guard against an
 701   // infinite loop if some other move to fs caused the GP fault. Note that
 702   // this loop counter is ultimately a heuristic as it is possible for
 703   // more than one thread to generate this fault at a time in an MP system.
 704   // In the case of the loop count being exceeded or if the poll fails
 705   // just fall through to a fatal error.
 706   // If there is some other source of T_GPFLT traps and the text at EIP is
 707   // unreadable this code will loop infinitely until the stack is exausted.
 708   // The key to diagnosis in this case is to look for the bottom signal handler
 709   // frame.
 710 
 711   if(! IgnoreLibthreadGPFault) {
 712     if (sig == SIGSEGV &amp;&amp; uc-&gt;uc_mcontext.gregs[TRAPNO] == T_GPFLT) {
 713       const unsigned char *p =
 714                         (unsigned const char *) uc-&gt;uc_mcontext.gregs[EIP];
 715 
 716       // Expected instruction?
 717 
 718       if(p[0] == movlfs[0] &amp;&amp; p[1] == movlfs[1]) {
 719 
 720         Atomic::inc(&amp;ldtr_refresh);
 721 
 722         // Infinite loop?
 723 
 724         if(ldtr_refresh &lt; ((2 &lt;&lt; 16) / PAGESIZE)) {
 725 
 726           // No, force scheduling to get a fresh view of the LDTR
 727 
 728           if(poll(NULL, 0, 10) == 0) {
 729 
 730             // Retry the move
 731 
 732             return false;
 733           }
 734         }
 735       }
 736     }
 737   }
 738 #endif // !AMD64
 739 
 740   if (!abort_if_unrecognized) {
 741     // caller wants another chance, so give it to him
 742     return false;
 743   }
 744 
 745   if (!os::Solaris::libjsig_is_loaded) {
 746     struct sigaction oldAct;
 747     sigaction(sig, (struct sigaction *)0, &amp;oldAct);
 748     if (oldAct.sa_sigaction != signalHandler) {
 749       void* sighand = oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
 750                                           : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
 751       warning("Unexpected Signal %d occurred under user-defined signal handler %#lx", sig, (long)sighand);
 752     }
 753   }
 754 
 755   if (pc == NULL &amp;&amp; uc != NULL) {
 756     pc = (address) uc-&gt;uc_mcontext.gregs[REG_PC];
 757   }
 758 
 759   // unmask current signal
 760   sigset_t newset;
 761   sigemptyset(&amp;newset);
 762   sigaddset(&amp;newset, sig);
 763   sigprocmask(SIG_UNBLOCK, &amp;newset, NULL);
 764 
 765   // Determine which sort of error to throw.  Out of swap may signal
 766   // on the thread stack, which could get a mapping error when touched.
 767   address addr = (address) info-&gt;si_addr;
 768   if (sig == SIGBUS &amp;&amp; info-&gt;si_code == BUS_OBJERR &amp;&amp; info-&gt;si_errno == ENOMEM) {
 769     vm_exit_out_of_memory(0, OOM_MMAP_ERROR, "Out of swap space to map in thread stack.");
 770   }
 771 
 772   VMError::report_and_die(t, sig, pc, info, ucVoid);
 773 
 774   ShouldNotReachHere();
 775   return false;
 776 }
 777 
 778 void os::print_context(outputStream *st, const void *context) {
 779   if (context == NULL) return;
 780 
 781   const ucontext_t *uc = (const ucontext_t*)context;
 782   st-&gt;print_cr("Registers:");
 783 #ifdef AMD64
 784   st-&gt;print(  "RAX=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RAX]);
 785   st-&gt;print(", RBX=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RBX]);
 786   st-&gt;print(", RCX=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RCX]);
 787   st-&gt;print(", RDX=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RDX]);
 788   st-&gt;cr();
 789   st-&gt;print(  "RSP=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RSP]);
 790   st-&gt;print(", RBP=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RBP]);
 791   st-&gt;print(", RSI=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RSI]);
 792   st-&gt;print(", RDI=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RDI]);
 793   st-&gt;cr();
 794   st-&gt;print(  "R8 =" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_R8]);
 795   st-&gt;print(", R9 =" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_R9]);
 796   st-&gt;print(", R10=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_R10]);
 797   st-&gt;print(", R11=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_R11]);
 798   st-&gt;cr();
 799   st-&gt;print(  "R12=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_R12]);
 800   st-&gt;print(", R13=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_R13]);
 801   st-&gt;print(", R14=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_R14]);
 802   st-&gt;print(", R15=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_R15]);
 803   st-&gt;cr();
 804   st-&gt;print(  "RIP=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RIP]);
 805   st-&gt;print(", RFLAGS=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_RFL]);
 806 #else
 807   st-&gt;print(  "EAX=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[EAX]);
 808   st-&gt;print(", EBX=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[EBX]);
 809   st-&gt;print(", ECX=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[ECX]);
 810   st-&gt;print(", EDX=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[EDX]);
 811   st-&gt;cr();
 812   st-&gt;print(  "ESP=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[UESP]);
 813   st-&gt;print(", EBP=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[EBP]);
 814   st-&gt;print(", ESI=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[ESI]);
 815   st-&gt;print(", EDI=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[EDI]);
 816   st-&gt;cr();
 817   st-&gt;print(  "EIP=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[EIP]);
 818   st-&gt;print(", EFLAGS=" INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[EFL]);
 819 #endif // AMD64
 820   st-&gt;cr();
 821   st-&gt;cr();
 822 
 823   intptr_t *sp = (intptr_t *)os::Solaris::ucontext_get_sp(uc);
 824   st-&gt;print_cr("Top of Stack: (sp=" PTR_FORMAT ")", sp);
 825   print_hex_dump(st, (address)sp, (address)(sp + 8*sizeof(intptr_t)), sizeof(intptr_t));
 826   st-&gt;cr();
 827 
 828   // Note: it may be unsafe to inspect memory near pc. For example, pc may
 829   // point to garbage if entry point in an nmethod is corrupted. Leave
 830   // this at the end, and hope for the best.
 831   ExtendedPC epc = os::Solaris::ucontext_get_ExtendedPC(uc);
 832   address pc = epc.pc();
 833   st-&gt;print_cr("Instructions: (pc=" PTR_FORMAT ")", pc);
 834   print_hex_dump(st, pc - 32, pc + 32, sizeof(char));
 835 }
 836 
 837 void os::print_register_info(outputStream *st, const void *context) {
 838   if (context == NULL) return;
 839 
 840   const ucontext_t *uc = (const ucontext_t*)context;
 841 
 842   st-&gt;print_cr("Register to memory mapping:");
 843   st-&gt;cr();
 844 
 845   // this is horrendously verbose but the layout of the registers in the
 846   // context does not match how we defined our abstract Register set, so
 847   // we can't just iterate through the gregs area
 848 
 849   // this is only for the "general purpose" registers
 850 
 851 #ifdef AMD64
 852   st-&gt;print("RAX="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RAX]);
 853   st-&gt;print("RBX="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RBX]);
 854   st-&gt;print("RCX="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RCX]);
 855   st-&gt;print("RDX="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RDX]);
 856   st-&gt;print("RSP="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RSP]);
 857   st-&gt;print("RBP="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RBP]);
 858   st-&gt;print("RSI="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RSI]);
 859   st-&gt;print("RDI="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RDI]);
 860   st-&gt;print("R8 ="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R8]);
 861   st-&gt;print("R9 ="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R9]);
 862   st-&gt;print("R10="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R10]);
 863   st-&gt;print("R11="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R11]);
 864   st-&gt;print("R12="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R12]);
 865   st-&gt;print("R13="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R13]);
 866   st-&gt;print("R14="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R14]);
 867   st-&gt;print("R15="); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R15]);
 868 #else
 869   st-&gt;print("EAX="); print_location(st, uc-&gt;uc_mcontext.gregs[EAX]);
 870   st-&gt;print("EBX="); print_location(st, uc-&gt;uc_mcontext.gregs[EBX]);
 871   st-&gt;print("ECX="); print_location(st, uc-&gt;uc_mcontext.gregs[ECX]);
 872   st-&gt;print("EDX="); print_location(st, uc-&gt;uc_mcontext.gregs[EDX]);
 873   st-&gt;print("ESP="); print_location(st, uc-&gt;uc_mcontext.gregs[UESP]);
 874   st-&gt;print("EBP="); print_location(st, uc-&gt;uc_mcontext.gregs[EBP]);
 875   st-&gt;print("ESI="); print_location(st, uc-&gt;uc_mcontext.gregs[ESI]);
 876   st-&gt;print("EDI="); print_location(st, uc-&gt;uc_mcontext.gregs[EDI]);
 877 #endif
 878 
 879   st-&gt;cr();
 880 }
 881 
 882 
 883 #ifdef AMD64
 884 void os::Solaris::init_thread_fpu_state(void) {
 885   // Nothing to do
 886 }
 887 #else
 888 // From solaris_i486.s
 889 extern "C" void fixcw();
 890 
 891 void os::Solaris::init_thread_fpu_state(void) {
 892   // Set fpu to 53 bit precision. This happens too early to use a stub.
 893   fixcw();
 894 }
 895 
 896 // These routines are the initial value of atomic_xchg_entry(),
 897 // atomic_cmpxchg_entry(), atomic_inc_entry() and fence_entry()
 898 // until initialization is complete.
 899 // TODO - replace with .il implementation when compiler supports it.
 900 
 901 typedef jint  xchg_func_t        (jint,  volatile jint*);
 902 typedef jint  cmpxchg_func_t     (jint,  volatile jint*,  jint);
 903 typedef jlong cmpxchg_long_func_t(jlong, volatile jlong*, jlong);
 904 typedef jint  add_func_t         (jint,  volatile jint*);
 905 
 906 jint os::atomic_xchg_bootstrap(jint exchange_value, volatile jint* dest) {
 907   // try to use the stub:
 908   xchg_func_t* func = CAST_TO_FN_PTR(xchg_func_t*, StubRoutines::atomic_xchg_entry());
 909 
 910   if (func != NULL) {
 911     os::atomic_xchg_func = func;
 912     return (*func)(exchange_value, dest);
 913   }
 914   assert(Threads::number_of_threads() == 0, "for bootstrap only");
 915 
 916   jint old_value = *dest;
 917   *dest = exchange_value;
 918   return old_value;
 919 }
 920 
 921 jint os::atomic_cmpxchg_bootstrap(jint exchange_value, volatile jint* dest, jint compare_value) {
 922   // try to use the stub:
 923   cmpxchg_func_t* func = CAST_TO_FN_PTR(cmpxchg_func_t*, StubRoutines::atomic_cmpxchg_entry());
 924 
 925   if (func != NULL) {
 926     os::atomic_cmpxchg_func = func;
 927     return (*func)(exchange_value, dest, compare_value);
 928   }
 929   assert(Threads::number_of_threads() == 0, "for bootstrap only");
 930 
 931   jint old_value = *dest;
 932   if (old_value == compare_value)
 933     *dest = exchange_value;
 934   return old_value;
 935 }
 936 
 937 jlong os::atomic_cmpxchg_long_bootstrap(jlong exchange_value, volatile jlong* dest, jlong compare_value) {
 938   // try to use the stub:
 939   cmpxchg_long_func_t* func = CAST_TO_FN_PTR(cmpxchg_long_func_t*, StubRoutines::atomic_cmpxchg_long_entry());
 940 
 941   if (func != NULL) {
 942     os::atomic_cmpxchg_long_func = func;
 943     return (*func)(exchange_value, dest, compare_value);
 944   }
 945   assert(Threads::number_of_threads() == 0, "for bootstrap only");
 946 
 947   jlong old_value = *dest;
 948   if (old_value == compare_value)
 949     *dest = exchange_value;
 950   return old_value;
 951 }
 952 
 953 jint os::atomic_add_bootstrap(jint add_value, volatile jint* dest) {
 954   // try to use the stub:
 955   add_func_t* func = CAST_TO_FN_PTR(add_func_t*, StubRoutines::atomic_add_entry());
 956 
 957   if (func != NULL) {
 958     os::atomic_add_func = func;
 959     return (*func)(add_value, dest);
 960   }
 961   assert(Threads::number_of_threads() == 0, "for bootstrap only");
 962 
 963   return (*dest) += add_value;
 964 }
 965 
 966 xchg_func_t*         os::atomic_xchg_func         = os::atomic_xchg_bootstrap;
 967 cmpxchg_func_t*      os::atomic_cmpxchg_func      = os::atomic_cmpxchg_bootstrap;
 968 cmpxchg_long_func_t* os::atomic_cmpxchg_long_func = os::atomic_cmpxchg_long_bootstrap;
 969 add_func_t*          os::atomic_add_func          = os::atomic_add_bootstrap;
 970 
 971 extern "C" void _solaris_raw_setup_fpu(address ptr);
 972 void os::setup_fpu() {
 973   address fpu_cntrl = StubRoutines::addr_fpu_cntrl_wrd_std();
 974   _solaris_raw_setup_fpu(fpu_cntrl);
 975 }
 976 #endif // AMD64
 977 
 978 #ifndef PRODUCT
 979 void os::verify_stack_alignment() {
 980 #ifdef AMD64
 981   assert(((intptr_t)os::current_stack_pointer() &amp; (StackAlignmentInBytes-1)) == 0, "incorrect stack alignment");
 982 #endif
 983 }
 984 #endif
 985 
 986 int os::extra_bang_size_in_bytes() {
 987   // JDK-8050147 requires the full cache line bang for x86.
 988   return VM_Version::L1_line_size();
 989 }
</pre></body></html>
